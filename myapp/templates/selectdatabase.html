{% extends 'base.html' %}
{% block headscript %}

{% endblock headscript %}
{% block body %}


<form method="post" class="mt-4 card" enctype="multipart/form-data" id='file-upload-form'>
    {% csrf_token %}
<div class="row mt-2 ml-2 mr-2">
    <div class="form-group col-xl-3 col-lg-3 col-md-6 col-sm-12 ">
        <label>Select Database</label>
        <select name='database' class="form-control" onchange="selecteddatabase()" id='database' required>
            {% for list in databases %}
            <option value='{{list}}'>{{ list }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group col-xl-3 col-lg-3 col-md-6 col-sm-12">
        <label>Select Table</label>
        <div id='tablelist'></div>
        
    </div>
    <div class="form-group col-xl-3 col-lg-3 col-md-6 col-sm-12">
        <label for='name'>Upload File:</label>
        <input type='file' class="form-control" accept=".csv" name='csvfile' id='csvfileinput' required>
        
    </div>
    <div class="col-xl-3 col-lg-3 col-md-6 col-sm-12 form-group m-auto d-flex justify-content-center">
        <button id='id_checkcsv' class="btn btn-success m-auto" style="width: max-content;" type="button">Validate</button>
        <button id='id_commit' class="btn btn-success m-auto" style="width: max-content;" type="button">Commit</button>
    </div>
</div>
</form>


<div id='id_column_table' style="margin-top: 2%;"></div>

<div hidden='true' id='id_error_div' style="margin-top: 2%;">
    <center>
        <h3 class="alert alert-warning" id='id_error_row'></h3>
    </center>
    <table class="table" id='error_table'>
    </table>
</div>

<div hidden="true" id='id_progress_parent'>
    <h3 class='alert alert-warning'>Do Not Refresh While Checking For Errors In The File</h3>
    <div class="progress">
        <div id='id_progressbar' class="progress-bar progress-bar-striped bg-success" role="progressbar"
                style="width: 0%"
                aria-valuenow="2" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
</div>


{% endblock body %}

{% block endscript%}
<!-- setting database list and table list -->
<script>
    // setting database list and table list
    loadtables = (list) => {
        var url = '/createmodel/?name=' + list
        $.ajax({
            url: url,
            success: function (data) {
                $('#tablelist').html(data)
                // get table column list after table list updated
            }
        })
    }
    $(document).ready(function () {
        $('#database').change()
    })
    selecteddatabase = () => {
        var database = $('#database').val()
        loadtables(database)

    }
</script>

<!-- getting form data on check csv button and checking for any error in the csv  -->
<script>
    function get_fields_data(){
        var header_list = []
        var table_list = []
        $('.csv_header').each(function(){
            header_list.push($(this).val())
        })
        $('.table_field').each(function(){
            table_list.push($(this).val())
        })
        // getting form data
        var data = new FormData($('#file-upload-form').get(0));
        for (var i = 0; i < table_list.length; i++) {
            data.append('table_list[]', table_list[i])
        }
        for (var i = 0; i < header_list.length; i++) {
            data.append('header_list[]', header_list[i])
        }
        return data
    }
    // getting form data on check csv button and checking for any error in the csv
    $('#id_checkcsv').click(function () {
        var url = "{% url 'myapp:CsvCheck' %}"
        formPost(url)
    })
    $('#id_commit').click(function () {
        console.log('ok')
        var url = "{% url 'myapp:ListDatabaseView' %}"
        formPost(url)
    })
    function formPost(url){
        var data = get_fields_data()
        $.ajax({
            data: data,
            type: $('#file-upload-form').attr('method'),
            url: url,
            cache: false,
            processData: false,
            contentType: false,
            xhr: function () {
                var xhr = new window.XMLHttpRequest();
                $('#id_progress_parent').prop('hidden', false)
                xhr.upload.addEventListener("progress", function (evt) {

                    if (evt.lengthComputable) {
                        var percentComplete = evt.loaded / evt.total;
                        percentComplete = parseInt(percentComplete * 100);
                        $('#id_progressbar').css('width', percentComplete);

                        if (percentComplete === 100) {
                            $('#id_progress_parent').prop('hidden', true)
                        }
                    }
                }, false);

                return xhr;
            },
            success: function (data) {
                console.log('start printing')

                // clearInterval(timer)

                // send alert if file not found or broken
                if (data['error_rows'] != '') {
                    $('#id_progress_parent').prop('hidden', true)
                    console.log($('#id_progress_parent').prop('hidden'))
                    $('#id_error_div').prop('hidden', false)
                    $('#id_error_row').html(data['error_rows'])
                }
            }
        });
        return false;
    
    }
        
</script>

<script>
    console.log("{% url 'myapp:ColumnMatcher' %}")
    function get_field_list() {
        console.log('okok')
        var data = new FormData($('#file-upload-form').get(0));
        $.ajax({
            type: "POST",
            url: "{% url 'myapp:ColumnMatcher' %}",
            data: data,
            cache: false,
            processData: false,
            contentType: false,
            success: function (data) {
                if (data['error_rows']){
                    console.log(data['error_rows'])
                    $('#id_error_div').prop('hidden', false)
                    $('#id_error_row').html(data['error_rows'])
                }
                else{
                    $('#id_error_div').prop('hidden', true)
                    $('#id_column_table').html(data)
                }
                // console.log(response)
                
            }
        });
    }

    $('#database').change(function(){
        if ($('#csvfileinput').val()) {
            get_field_list()
        }
    })
    $('#csvfileinput').change(function(){
        if ($('#csvfileinput').val()) {
            get_field_list()
        }
    })
</script>

<script>
    if ('{{error}}' != 'None') {
        console.log('----------------------------{{error}}')
        $('#id_error_div').prop('hidden', false)
        $('#id_error_row').html('{{error}}')
    }
</script>

<script>
    $('#id_checkcsv').prop('hidden',true)
    $('#id_commit').prop('hidden',true)
</script>













<!-- <script>
function setprogress() {
    $.ajax({
        url: '/getcurrentprocesscount/',
        success: function (data) {
            let completed = (data['current_counter'] / data['total_counter']) * 100
            $('#id_progressbar').css('width', completed + '%')
        }
    })
}
</script> -->


<!-- get column table -->
<!-- <script>
    $('#id_getcolumns').click(function () {
        var data = new FormData($('#file-upload-form').get(0));
        console.log(data)
        for(i of data){
            console.log(i)
        }
        $('#id_error_div').prop('hidden', true)
        $('#id_error_row').html('')
        $.ajax({
            data: data,
            type: $('#file-upload-form').attr('method'),
            url: '/responseCsvHeader/',
            cache: false,
            processData: false,
            contentType: false,
            success: function (data) {
                console.log('start printing')
                // clearInterval(timer)

                // send alert if file not found or broken
                if (data['error_rows'] != undefined) {
                    console.log('-----=======',data['error_rows'])
                    $('#id_progress_parent').prop('hidden', true)
                    console.log($('#id_progress_parent').prop('hidden'))
                    $('#id_error_div').prop('hidden', false)
                    $('#id_error_row').html(data['error_rows'])
                }
                console.log(data)
                console.log('--------',data['header_data'])
                var list = ''
                $('#id_csv_header').html(data)
            }
        })
    })
</script> -->


{% endblock endscript%}
